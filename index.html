<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Bar Chart</title>
  <!-- jQuery CDN -->
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
  <script src="./scripts/jquery.keyframes.min.js"></script>
</head>

<body>
  <div id="container"></div>
  <script>
    const test = {
      //HTML: 200,
      //JavaScript: 80,
      //CSS: 45,
      "React": [{ val: 70, color: 'purple' }, { val: 10, color: 'green' }, { val: 20, color: 'orange' }],
      'C#': [{ val: 62, color: 'blue' }],
      'MONGO': [{ val: 74, color: 'gray' }],
      'FIREBASE': [{ val: 33, color: 'orange' }, { val: 15, color: 'black' }],
      'SQL': [{ val:100, color:'green '}],
    }
    $(function () {
      let config = {
        title: 'The most awesome technologies',
        titleColor: 'purple',
        titleFontSize: '25pt',
        width: '100%',
        height: '80px',
        barColor: 'purple',
        barSpacing: '60',
        labelColor: 'white',
        labelPosition: 'centre',
      }
      drawBarChart(test, config, '#container');
      //var supportedFlag = $;
      //alert(supportedFlag)
    });

    function drawBarChart(data, options, element) {
      //debugger;
      setMainLayout(element, options.title);
      //let max = getMaxValue(data);
      let max = 100;

      let yValues = [...Array(Object.keys(data).length).fill(0)];
      yValues = yValues.map((x, ix) => (100 / yValues.length * (yValues.length - ix)).toFixed(0))

      $('.chart').css({ 'grid-template-columns': 'repeat(' + Object.keys(data).length + ', 1fr)' });
      $('.labels').css({ 'grid-template-columns': 'repeat(' + Object.keys(data).length + ', 1fr)' });


      for (let i = 0; i < Object.keys(data).length; i++) {
        let key = Object.keys(data)[i];
        //alert(key)
        $('.yAxis').append('<div class="yAx y">' + yValues[i] + '%</div>');
        $('.chart').append('<div class="row row' + (i + 1) + '"></div>');
        //$('.chart').append('<div class="col col' + (i + 1) + '"><div class="bar bar' + (i + 1) + '"><span class="percent">' + test[key].val + '</span></div></div>');
        $('.chart').append('<div class="col col' + (i + 1) + '"></div>');

        $('.labels').append('<div class="label l' + (i + 1) + '">' + key + '</div>');
        $('.row' + (i + 1)).css({ 'grid-row': (i + 1) });
        $('.col' + (i + 1)).css({ 'grid-column': (i + 1) });
        $('.row' + (i + 1)).css({ 'background': i % 2 === 0 ? '#d5d5d5' : '#f2f2f2' });
        //$.keyframe.define([{ 'name': 'barAnim' + (i + 1), '0%': { 'height': 0 }, '100%': { 'height': 100 } }]);

        let bottom = 0;
        for(let j = 0; j < test[key].length; j++) {
          $.keyframe.define([{ 'name': 'barAnim' + (i + 1) + (j + 1), '0%': { 'height': 0 }, '100%': { 'height': 100 } }]);
          //alert(j)
          //alert(test[key][j].val);
          $('.col' + (i + 1)).append('<div class="bar bar' + (i + 1) + (j + 1) + '"><span class="percent">' + test[key][j].val + '</span></div>');
          $('.bar' + (i + 1) + (j + 1)).css({ 'height': (test[key][j].val / max * 100) + '%' , 'bottom': bottom + '%' });
          bottom += (test[key][j].val / max * 100);
          $('.bar' + (i + 1) + (j + 1)).css({ 'animation': 'barAnim' + (i + 1) + (j + 1) + ' 1.5s ease-out', 'background': test[key][j].color });
          if(test[key].length - j === 1) {
            $('.bar' + (i + 1) + (j + 1)).css({ 'border-top-right-radius': '10px','border-top-left-radius': '10px' });
          }
        }


      }
      $('.col').css({ 'grid-row': '1/' + (Object.keys(data).length + 1) });
      $('.row').css({ 'grid-column': '1/' + (Object.keys(data).length + 1) });
      $('.chart').css({ 'grid-auto-rows': 'minmax(' + options.height + ', auto)' });
      $('.title').css({ 'color': options.titleColor, 'font-size': options.titleFontSize });
      $('.bar').css({ 'width': (100 - options.barSpacing) + '%', 'left': (options.barSpacing / 2) + '%'});

      //$('.bar').css({ 'background-image': 'linear-gradient(to left, ' + options.barColor + ', ' + (options.barColor) + ')' });
      $('.percent').css({ 'color': options.labelColor, 'bottom': options.labelPosition === 'top' ? '85%' : options.labelPosition === 'centre' ? '45%' : '10%' });
      $('.percent').css({ 'left': ((100 - options.barSpacing) / 2 + 10) + '%' });
      $("head").append($('<style>.bar::after {position: absolute;top: 0;left: 0;right: 0;bottom: 0;content: "";background-size: 100%;background-image: linear-gradient(25deg, #fff 25%,rgba(0, 0, 0, 0) 25%,rgba(0, 0, 0, 0) 50%,#fff 50%,#fff 75%,rgba(0, 0, 0, 0));background-size: 200% 50%;opacity: 0.2;animation: barInner 2s infinite linear;}</style>'));
      $.keyframe.define([{ 'name': 'barInner', '0%': { 'background-position': '0 100%' }, '100%': { 'background-position-y': '30px 0%' } }]);

      Object.keys(chartStyles).map(x => {
        // let selector = x.split('_')[0];
        // selector = selector === 'class' ? '.' : selector === 'id' ? '#' : selector === 'all' ? '*' : '';
        // $(selector + x.split('_')[1]).css(chartStyles[x]);
        $(x).css(chartStyles[x]);
      });

      Object.keys(data).map(x => {
        console.log(x);
      });
      // $('.bar').toggleClass('changed');
    }


    function setMainLayout(holder, title) {
      const layout = '<div class="wrapper"><div class="title">' + (title || "Bar Chart") + '</div><div class="yAxis"></div><div class="chart"></div><div class="labels"></div></div>';
      $(holder).append(layout);
    }
    function getMaxValue(obj) {
      let max = 0;
      Object.keys(obj).map(key => {
        max = obj[key].val > max ? obj[key].val : max
      });
      return max;
    }

    var yAxis = '<div class="yAx y">Data</div>';
    var row = '<div class="row row1"></div>';
    const chartStyles = {
      '*': {
        'margin': '10 8px 0 0',
        'font-family': "'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif"
      },
      '.wrapper': {
        'display': 'grid',
        'grid-template-columns': '1fr 10fr'
      },
      '.title': {
        'margin': '40px 0 40px 0',
        'grid-column': '1/3',
        'grid-row': 1,
        //'border': '#000 1px solid',
        'text-align': 'center'
      },
      '.yAxis': {
        //'border': '#000 1px solid',
        'grid-column': '1/2',
        'grid-row': 2,
        'display': 'grid',
        'width': 'auto'

      },
      '.yAx': {
        //'border': '#000 1px solid',
        //'text-align': 'center'
        'text-align': 'right',
        'margin-top': '-10px',
        'margin-right': '15px'
      },
      '.chart': {
        'grid-column': '2/3',
        'grid-row': 2,
        'display': 'grid',
        //'grid-template-columns': 'repeat(5, 1fr)',
        //'grid-auto-rows': 'minmax(100px, auto)',
        //'grid-gap': '1em'
      },
      '.labels': {
        //'border': '#000 1px solid',
        'height': '50px',
        'grid-column': '2/3',
        'grid-row': 3,
        'display': 'grid',
        //'grid-template-columns': 'repeat(5, 1fr)'
      },
      '.label': {
        //'background': 'yellow',
        //'border': '#000 1px solid',
        'margin-top': '10px',
        'text-align': 'center'
      },
      // '.row': {

      // },

      '.row': {
        'border-bottom': '#ccc 1px solid',
        //'border-top': '#999 1px solid',
        // 'background': '#245'
        //'grid-column': '1/6'
      },
      // '.row1:nth-child(even)': {
      //   'background': '#fff'
      // },
      // '.row2:nth-child(odd)': {
      //   'background': '#000'
      // },
      '.col': {
        'position': 'relative',
        //'border': '1px solid #000',
        //'grid-row': '1/7'

      },
      '.bar': {
        'position': 'absolute',
        'border': '#999 1px solid',
        //'bottom': 0,
        //'width': '50%',
        //'left': '25%',
        'text-align': 'center',
        //'border-top-right-radius': '10px',
        //'border-top-left-radius': '10px',
      },
      '.changed::after': {
        'position': 'absolute',
        'top': '0',
        'left': '0',
        'right': '0',
        'bottom': '0',
        'content': '',
        'background-size': '100%',
        'background-image': 'linear-gradient(25deg, #fff 25%, rgba(0, 0, 0, 0) 25%, rgba(0, 0, 0, 0) 50%, #fff 50%, #fff 75%, rgba(0, 0, 0, 0))',
        'background-size': '200% 50%',
        'opacity': '0.15',
        //'animation': 'barInner 2s infinite linear',
      },
      '.percent': {
        'position': 'absolute',
        'display': 'inline-block',
        'font-weight': 'bold',
        //'color': 'red',
        //'bottom': '45%',
        //'left': '25%'
      }
    };
  </script>
</body>

</html>
